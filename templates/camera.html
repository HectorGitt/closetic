<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Live Camera Fashion Check</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
			rel="stylesheet"
		/>
		<style>
			.camera-container {
				position: relative;
				background: #000;
				border-radius: 10px;
				overflow: hidden;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
			}

			#videoElement {
				width: 100%;
				height: auto;
				display: block;
			}

			.camera-controls {
				position: absolute;
				bottom: 20px;
				left: 50%;
				transform: translateX(-50%);
				display: flex;
				gap: 10px;
			}

			.capture-btn {
				width: 60px;
				height: 60px;
				border-radius: 50%;
				background: #fff;
				border: 3px solid #007bff;
				color: #007bff;
				font-size: 24px;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.capture-btn:hover {
				background: #007bff;
				color: #fff;
			}

			.switch-camera-btn {
				width: 50px;
				height: 50px;
				border-radius: 50%;
				background: rgba(255, 255, 255, 0.9);
				border: 2px solid #6c757d;
				color: #6c757d;
				font-size: 18px;
				cursor: pointer;
			}

			.analysis-panel {
				background: #f8f9fa;
				border-radius: 10px;
				min-height: 400px;
			}

			.btn-fashion {
				background: linear-gradient(45deg, #667eea, #764ba2);
				border: none;
				color: white;
			}

			.btn-fashion:hover {
				background: linear-gradient(45deg, #764ba2, #667eea);
				color: white;
			}

			.live-analysis {
				border: 2px solid #28a745;
				border-radius: 10px;
				padding: 15px;
				background: #d4edda;
			}

			.captured-image {
				max-width: 100%;
				border-radius: 10px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			}

			.status-indicator {
				position: absolute;
				top: 10px;
				right: 10px;
				padding: 5px 10px;
				border-radius: 15px;
				font-size: 12px;
				font-weight: bold;
			}

			.status-live {
				background: #28a745;
				color: white;
			}

			.status-paused {
				background: #ffc107;
				color: #212529;
			}
		</style>
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
			<div class="container">
				<a class="navbar-brand" href="/">
					<i class="fas fa-tshirt me-2"></i>Fashion Check
				</a>
				<div class="navbar-nav ms-auto">
					<a class="nav-link" href="/">Home</a>
					<a class="nav-link" href="/fashion/analyze"
						>Upload Analysis</a
					>
					<a class="nav-link" href="/users/profile">Profile</a>
				</div>
			</div>
		</nav>

		<div class="container my-5">
			<div class="row">
				<div class="col-md-8">
					<div class="card">
						<div class="card-header">
							<h5 class="mb-0">
								<i class="fas fa-video me-2"></i>Live Camera
								Fashion Check
							</h5>
						</div>
						<div class="card-body p-0">
							<div class="camera-container">
								<video id="videoElement" autoplay muted></video>
								<canvas
									id="captureCanvas"
									style="display: none"
								></canvas>

								<div
									class="status-indicator status-paused"
									id="statusIndicator"
								>
									Camera Stopped
								</div>

								<div class="camera-controls">
									<button
										class="switch-camera-btn"
										id="switchCameraBtn"
										title="Switch Camera"
									>
										<i class="fas fa-sync-alt"></i>
									</button>
									<button
										class="capture-btn"
										id="captureBtn"
										title="Capture Photo"
									>
										<i class="fas fa-camera"></i>
									</button>
								</div>
							</div>

							<div class="p-3">
								<div class="row">
									<div class="col-md-6">
										<button
											class="btn btn-success w-100"
											id="startCameraBtn"
										>
											<i class="fas fa-play me-2"></i
											>Start Camera
										</button>
									</div>
									<div class="col-md-6">
										<button
											class="btn btn-danger w-100"
											id="stopCameraBtn"
											disabled
										>
											<i class="fas fa-stop me-2"></i>Stop
											Camera
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-md-4">
					<div class="card analysis-panel">
						<div class="card-header">
							<h6 class="mb-0">
								<i class="fas fa-chart-line me-2"></i>Analysis
								Controls
							</h6>
						</div>
						<div class="card-body">
							<div class="mb-3">
								<label
									for="analysisTypeCamera"
									class="form-label"
									>Analysis Type</label
								>
								<select
									class="form-select"
									id="analysisTypeCamera"
								>
									<option value="comprehensive">
										Comprehensive
									</option>
									<option value="color_match">
										Color Focus
									</option>
									<option value="style_suggestions">
										Style Focus
									</option>
								</select>
							</div>

							<div class="mb-3">
								<div class="form-check">
									<input
										class="form-check-input"
										type="checkbox"
										id="liveAnalysisMode"
									/>
									<label
										class="form-check-label"
										for="liveAnalysisMode"
									>
										Live Analysis Mode
									</label>
									<small class="form-text text-muted"
										>Analyze automatically every 5
										seconds</small
									>
								</div>
							</div>

							<button
								class="btn btn-fashion w-100 mb-3"
								id="analyzeCurrentBtn"
								disabled
							>
								<i class="fas fa-search me-2"></i>Analyze
								Current View
							</button>

							<div
								id="capturedImageContainer"
								style="display: none"
							>
								<h6>Last Capture:</h6>
								<img
									id="capturedImage"
									class="captured-image mb-3"
									alt="Captured"
								/>
								<button
									class="btn btn-primary w-100"
									id="analyzeCaptureBtn"
								>
									<i class="fas fa-magic me-2"></i>Analyze
									Capture
								</button>
							</div>
						</div>
					</div>

					<div
						class="card mt-3"
						id="liveAnalysisPanel"
						style="display: none"
					>
						<div class="card-header bg-success text-white">
							<h6 class="mb-0">
								<i class="fas fa-bolt me-2"></i>Live Analysis
							</h6>
						</div>
						<div class="card-body">
							<div id="liveAnalysisContent">
								<div class="text-center">
									<i
										class="fas fa-spinner fa-spin fa-2x mb-2"
									></i>
									<p>Starting live analysis...</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Analysis Results Modal -->
			<div class="modal fade" id="analysisModal" tabindex="-1">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">
								Fashion Analysis Results
							</h5>
							<button
								type="button"
								class="btn-close"
								data-bs-dismiss="modal"
							></button>
						</div>
						<div class="modal-body">
							<div id="modalAnalysisResults"></div>
						</div>
						<div class="modal-footer">
							<button
								type="button"
								class="btn btn-secondary"
								data-bs-dismiss="modal"
							>
								Close
							</button>
							<button
								type="button"
								class="btn btn-primary"
								id="saveAnalysisBtn"
							>
								Save Analysis
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			let currentStream = null;
			let currentCamera = "user"; // 'user' for front, 'environment' for back
			let liveAnalysisInterval = null;
			let lastAnalysisResult = null;

			const videoElement = document.getElementById("videoElement");
			const captureCanvas = document.getElementById("captureCanvas");
			const captureBtn = document.getElementById("captureBtn");
			const startCameraBtn = document.getElementById("startCameraBtn");
			const stopCameraBtn = document.getElementById("stopCameraBtn");
			const switchCameraBtn = document.getElementById("switchCameraBtn");
			const statusIndicator = document.getElementById("statusIndicator");
			const liveAnalysisMode =
				document.getElementById("liveAnalysisMode");
			const liveAnalysisPanel =
				document.getElementById("liveAnalysisPanel");
			const analyzeCurrentBtn =
				document.getElementById("analyzeCurrentBtn");
			const analysisModal = new bootstrap.Modal(
				document.getElementById("analysisModal")
			);

			// Initialize camera
			startCameraBtn.addEventListener("click", startCamera);
			stopCameraBtn.addEventListener("click", stopCamera);
			captureBtn.addEventListener("click", capturePhoto);
			switchCameraBtn.addEventListener("click", switchCamera);
			analyzeCurrentBtn.addEventListener("click", analyzeCurrentFrame);
			document
				.getElementById("analyzeCaptureBtn")
				.addEventListener("click", analyzeCapture);

			liveAnalysisMode.addEventListener("change", function () {
				if (this.checked) {
					startLiveAnalysis();
				} else {
					stopLiveAnalysis();
				}
			});

			async function startCamera() {
				try {
					currentStream = await navigator.mediaDevices.getUserMedia({
						video: { facingMode: currentCamera },
						audio: false,
					});

					videoElement.srcObject = currentStream;

					// Update UI
					startCameraBtn.disabled = true;
					stopCameraBtn.disabled = false;
					captureBtn.disabled = false;
					analyzeCurrentBtn.disabled = false;
					switchCameraBtn.disabled = false;

					statusIndicator.textContent = "Live";
					statusIndicator.className = "status-indicator status-live";
				} catch (error) {
					console.error("Error accessing camera:", error);
					alert("Error accessing camera. Please check permissions.");
				}
			}

			function stopCamera() {
				if (currentStream) {
					currentStream.getTracks().forEach((track) => track.stop());
					currentStream = null;
					videoElement.srcObject = null;
				}

				stopLiveAnalysis();

				// Update UI
				startCameraBtn.disabled = false;
				stopCameraBtn.disabled = true;
				captureBtn.disabled = true;
				analyzeCurrentBtn.disabled = true;
				switchCameraBtn.disabled = true;

				statusIndicator.textContent = "Camera Stopped";
				statusIndicator.className = "status-indicator status-paused";
			}

			async function switchCamera() {
				if (currentStream) {
					stopCamera();
					currentCamera =
						currentCamera === "user" ? "environment" : "user";
					await startCamera();
				}
			}

			function capturePhoto() {
				if (!currentStream) return;

				const canvas = captureCanvas;
				const video = videoElement;

				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;

				const ctx = canvas.getContext("2d");
				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

				// Convert to blob and display
				canvas.toBlob(
					(blob) => {
						const url = URL.createObjectURL(blob);
						document.getElementById("capturedImage").src = url;
						document.getElementById(
							"capturedImageContainer"
						).style.display = "block";
					},
					"image/jpeg",
					0.8
				);
			}

			async function analyzeCurrentFrame() {
				if (!currentStream) return;

				const canvas = captureCanvas;
				const video = videoElement;

				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;

				const ctx = canvas.getContext("2d");
				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

				const dataURL = canvas.toDataURL("image/jpeg", 0.8);
				await analyzeImage(dataURL);
			}

			async function analyzeCapture() {
				const capturedImage = document.getElementById("capturedImage");
				if (!capturedImage.src) return;

				// Convert image to canvas to get data URL
				const canvas = document.createElement("canvas");
				const ctx = canvas.getContext("2d");

				canvas.width = capturedImage.naturalWidth;
				canvas.height = capturedImage.naturalHeight;
				ctx.drawImage(capturedImage, 0, 0);

				const dataURL = canvas.toDataURL("image/jpeg", 0.8);
				await analyzeImage(dataURL);
			}

			async function analyzeImage(imageData) {
				const analysisType =
					document.getElementById("analysisTypeCamera").value;

				try {
					const token = localStorage.getItem("access_token");
					if (!token) {
						window.location.href =
							"/auth/login?redirect=" +
							encodeURIComponent(window.location.pathname);
						return;
					}

					const response = await fetch("/fashion/camera-analyze", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							Authorization: `Bearer ${token}`,
						},
						body: JSON.stringify({
							image_data: imageData,
							analysis_type: analysisType,
						}),
					});

					if (response.status === 401) {
						// Token expired, redirect to login
						localStorage.removeItem("access_token");
						localStorage.removeItem("user_info");
						window.location.href =
							"/auth/login?redirect=" +
							encodeURIComponent(window.location.pathname);
						return;
					}

					const result = await response.json();

					if (result.success) {
						lastAnalysisResult = result;
						displayAnalysisResults(result);
					} else {
						throw new Error(result.detail || "Analysis failed");
					}
				} catch (error) {
					console.error("Analysis error:", error);
					alert("Error analyzing image: " + error.message);
				}
			}

			function displayAnalysisResults(result) {
				const modalContent = document.getElementById(
					"modalAnalysisResults"
				);

				let html = '<div class="row">';

				// Analysis section
				html += '<div class="col-md-6">';
				html +=
					'<h6><i class="fas fa-chart-bar me-2"></i>Analysis</h6>';
				html += formatAnalysisForModal(result.analysis);
				html += "</div>";

				// Recommendations section
				html += '<div class="col-md-6">';
				html +=
					'<h6><i class="fas fa-lightbulb me-2"></i>Recommendations</h6>';
				html += formatRecommendationsForModal(result.recommendations);
				html += "</div>";

				html += "</div>";

				modalContent.innerHTML = html;
				analysisModal.show();
			}

			function formatAnalysisForModal(analysis) {
				if (analysis.raw_analysis) {
					return `<div class="alert alert-info">${analysis.raw_analysis.replace(
						/\n/g,
						"<br>"
					)}</div>`;
				}

				let html = "";

				if (analysis.overall_rating) {
					const rating = analysis.overall_rating;
					const badgeClass =
						rating >= 8
							? "bg-success"
							: rating >= 6
							? "bg-warning"
							: "bg-danger";
					html += `<div class="mb-2">
                    <span class="badge ${badgeClass}">Rating: ${rating}/10</span>
                </div>`;
				}

				if (analysis.color_analysis) {
					html += `<div class="mb-2">
                    <strong>Colors:</strong> ${analysis.color_analysis}
                </div>`;
				}

				if (analysis.fit_analysis) {
					html += `<div class="mb-2">
                    <strong>Fit:</strong> ${analysis.fit_analysis}
                </div>`;
				}

				return html || "<p>Analysis completed!</p>";
			}

			function formatRecommendationsForModal(recommendations) {
				if (!recommendations)
					return "<p>No recommendations available.</p>";

				if (recommendations.raw_recommendations) {
					return `<div class="alert alert-success">${recommendations.raw_recommendations.replace(
						/\n/g,
						"<br>"
					)}</div>`;
				}

				let html = "";

				if (recommendations.immediate_improvements) {
					html += `<div class="mb-2">
                    <strong>Improvements:</strong> ${recommendations.immediate_improvements}
                </div>`;
				}

				if (recommendations.accessories) {
					html += `<div class="mb-2">
                    <strong>Accessories:</strong> ${recommendations.accessories}
                </div>`;
				}

				return html || "<p>No specific recommendations.</p>";
			}

			function startLiveAnalysis() {
				if (!currentStream) {
					alert("Please start the camera first");
					liveAnalysisMode.checked = false;
					return;
				}

				liveAnalysisPanel.style.display = "block";

				liveAnalysisInterval = setInterval(async () => {
					try {
						await analyzeCurrentFrame();
						updateLiveAnalysisPanel();
					} catch (error) {
						console.error("Live analysis error:", error);
					}
				}, 5000); // Analyze every 5 seconds
			}

			function stopLiveAnalysis() {
				if (liveAnalysisInterval) {
					clearInterval(liveAnalysisInterval);
					liveAnalysisInterval = null;
				}
				liveAnalysisPanel.style.display = "none";
				liveAnalysisMode.checked = false;
			}

			function updateLiveAnalysisPanel() {
				if (!lastAnalysisResult) return;

				const content = document.getElementById("liveAnalysisContent");
				const analysis = lastAnalysisResult.analysis;

				let html = '<div class="live-analysis">';

				if (analysis.overall_rating) {
					const rating = analysis.overall_rating;
					const badgeClass =
						rating >= 8
							? "bg-success"
							: rating >= 6
							? "bg-warning"
							: "bg-danger";
					html += `<div class="text-center mb-2">
                    <span class="badge ${badgeClass} fs-6">Rating: ${rating}/10</span>
                </div>`;
				}

				if (analysis.raw_analysis) {
					const shortAnalysis =
						analysis.raw_analysis.substring(0, 200) + "...";
					html += `<p class="small">${shortAnalysis}</p>`;
				}

				html += '<div class="text-center">';
				html +=
					'<small class="text-muted">Updated: ' +
					new Date().toLocaleTimeString() +
					"</small>";
				html += "</div>";
				html += "</div>";

				content.innerHTML = html;
			}

			// Save analysis functionality
			document
				.getElementById("saveAnalysisBtn")
				.addEventListener("click", async function () {
					if (lastAnalysisResult) {
						try {
							// Here you could save to user profile or local storage
							console.log("Saving analysis:", lastAnalysisResult);
							alert("Analysis saved successfully!");
							analysisModal.hide();
						} catch (error) {
							console.error("Error saving analysis:", error);
							alert("Error saving analysis");
						}
					}
				});
		</script>
	</body>
</html>
